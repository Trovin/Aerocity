window.GFStripe=null,function(a){GFStripe=function(b){for(var c in b)b.hasOwnProperty(c)&&(this[c]=b[c]);this.form=null,this.init=function(){if(this.isCreditCardOnPage()||"checkout"===this.stripe_payment){var b=this;if("stripe.js"!==b.stripe_payment){var c=0,d=null,e=!1,f=!1;gform.addAction("gform_frontend_feed_activated",function(a,g){if("gravityformsstripe"===a.addonSlug&&a.isActivated){e=!0,c=a.feedId;for(var h=0;h<Object.keys(b.feeds).length;h++)if(b.feeds[h].feedId===c){d=b.feeds[h],"elements"===b.stripe_payment&&(f=""!==d.address_zip);break}}}),gform.addAction("gform_frontend_feed_deactivated",function(d,g){"gravityformsstripe"!==d.addonSlug||d.isActivated||c!==d.feedId||(e=!1,"elements"===b.stripe_payment&&(f=!1),b.form=a("#gform_"+g),b.resetStripeStatus(b.form,g,b.isLastPage()))})}switch(b.stripe_payment){case"elements":var g=Stripe(this.apiKey),h=g.elements(),i="#input_"+b.formId+"_"+b.ccFieldId+"_1",j=null;gform.addAction("gform_frontend_feeds_evaluated",function(){if(e)h._elements.indexOf("card")>=0&&j.destroy(),a(i).next(".validation_message").length&&a(i).next(".validation_message").html(""),j=h.create("card",{classes:b.cardClasses,style:b.cardStyle,hidePostalCode:f}),j.mount(i),j.on("change",function(a){b.displayStripeCardError(a)});else{h._elements.indexOf("card")>=0&&j.destroy(),a(i).next(".validation_message").length||a(i).after('<div class="gfield_description validation_message"></div>');a(i).next(".validation_message").html(gforms_stripe_frontend_strings.no_active_frontend_feed)}});break;case"checkout":var k,l=a("#gform_"+this.formId),m={key:this.apiKey,token:function(b){a("#gf_stripe_response").length?a("#gf_stripe_response").val(a.toJSON(b)):l.append(a('<input type="hidden" name="stripe_response" id="gf_stripe_response" />').val(a.toJSON(b))),l.submit()}};gform.addFilter("gform_product_total",function(a,b){return window["gform_stripe_checkout_amount_"+b]=a,a},51),k=StripeCheckout.configure(m),a(document).on("gform_price_change",function(){a("#gf_stripe_response").length&&a("#gf_stripe_response").val("")}),a("#gform_submit_button_"+this.formId).on("click",function(c){if(e&&!l.data("gfstripesubmitting")){if(a("#gf_stripe_response").length&&""!==a("#gf_stripe_response").val()){if(a.parseJSON(a("#gf_stripe_response").val()).id)return void l.submit()}m={amount:0===gf_global.gf_currency_config.decimals?window["gform_stripe_checkout_amount_"+b.formId]:100*window["gform_stripe_checkout_amount_"+b.formId],currency:gform.applyFilters("gform_stripe_currency",b.currency,b.formId),locale:"auto",image:d.logoUrl,name:GFMergeTag.replaceMergeTags(b.formId,d.name),description:GFMergeTag.replaceMergeTags(b.formId,d.description),zipCode:!0},m.billingAddress=d.billingAddress,m=gform.applyFilters("gform_stripe_checkout_options",m,b.formId),m.amount>0&&(c.preventDefault(),m.amount=Math.round(m.amount),k.open(m))}}),window.addEventListener("popstate",function(){k.close()});break;case"stripe.js":Stripe.setPublishableKey(this.apiKey)}a("#gform_"+this.formId).submit(function(c){if(("stripe.js"===b.stripe_payment||e)&&!(a(this).data("gfstripesubmitting")||1==a("#gform_save_"+b.formId).val()||!b.isLastPage()&&"elements"!==b.stripe_payment||gformIsHidden(a(i))))switch(c.preventDefault(),a(this).data("gfstripesubmitting",!0),b.maybeAddSpinner(),b.stripe_payment){case"elements":if(b.form=a(this),b.isLastPage()&&!b.isCreditCardOnPage()||gformIsHidden(a(i)))return void a(this).submit();var f=a("#input_"+b.formId+"_"+b.ccFieldId+"_5").val(),h={name:f,address_line1:GFMergeTag.replaceMergeTags(b.formId,b.getBillingAddressMergeTag(d.address_line1)),address_line2:GFMergeTag.replaceMergeTags(b.formId,b.getBillingAddressMergeTag(d.address_line2)),address_city:GFMergeTag.replaceMergeTags(b.formId,b.getBillingAddressMergeTag(d.address_city)),address_state:GFMergeTag.replaceMergeTags(b.formId,b.getBillingAddressMergeTag(d.address_state)),address_zip:GFMergeTag.replaceMergeTags(b.formId,b.getBillingAddressMergeTag(d.address_zip)),address_country:GFMergeTag.replaceMergeTags(b.formId,b.getBillingAddressMergeTag(d.address_country)),currency:gform.applyFilters("gform_stripe_currency",b.currency,b.formId)};g.createToken(j,h).then(function(a){b.elementsResponseHandler(a)});break;case"checkout":window["gform_stripe_checkout_amount_"+b.formId]>0?(b.form=a(this),b.checkoutResponseHandler()):a(this).submit();break;case"stripe.js":var k=a(this),l="input_"+b.formId+"_"+b.ccFieldId+"_",m={number:k.find("#"+l+"1").val(),exp_month:k.find("#"+l+"2_month").val(),exp_year:k.find("#"+l+"2_year").val(),cvc:k.find("#"+l+"3").val(),name:k.find("#"+l+"5").val()};b.form=k,Stripe.card.createToken(m,function(a,c){b.responseHandler(a,c)})}})}},this.getBillingAddressMergeTag=function(a){return""===a?"":"{:"+a+"}"},this.responseHandler=function(b,c){for(var d=this.form,e="input_"+this.formId+"_"+this.ccFieldId+"_",f=["1","2_month","2_year","3","5"],g=0;g<f.length;g++){var h=d.find("#"+e+f[g]);if("1"==f[g]){var i=a.trim(h.val()),j=gformFindCardType(i);void 0!==this.cardLabels[j]&&(j=this.cardLabels[j]),d.append(a('<input type="hidden" name="stripe_credit_card_last_four" />').val(i.slice(-4))),d.append(a('<input type="hidden" name="stripe_credit_card_type" />').val(j))}}d.append(a('<input type="hidden" name="stripe_response" />').val(a.toJSON(c))),d.submit()},this.elementsResponseHandler=function(b){var c=this.form;a("#gf_stripe_response").length?a("#gf_stripe_response").val(a.toJSON(b)):c.append(a('<input type="hidden" name="stripe_response" id="gf_stripe_response" />').val(a.toJSON(b))),b.error?(this.displayStripeCardError(b),this.resetStripeStatus(c,this.formId,this.isLastPage())):(c.append(a('<input type="hidden" name="stripe_credit_card_last_four" id="gf_stripe_credit_card_last_four" />').val(b.token.card.last4)),c.append(a('<input type="hidden" name="stripe_credit_card_type" id="stripe_credit_card_type" />').val(b.token.card.brand)),c.submit())},this.checkoutResponseHandler=function(){var b=this.form,c=a.parseJSON(a("#gf_stripe_response").val());c.error||""===c?this.resetStripeStatus(b,this.formId,this.isLastPage()):(b.append(a('<input type="hidden" name="stripe_credit_card_last_four" id="gf_stripe_credit_card_last_four" />').val(c.card.last4)),b.append(a('<input type="hidden" name="stripe_credit_card_type" id="stripe_credit_card_type" />').val(c.card.brand)),b.submit())},this.isLastPage=function(){var b=a("#gform_target_page_number_"+this.formId);return!(b.length>0)||0==b.val()},this.isCreditCardOnPage=function(){var a=this.getCurrentPageNumber();return!this.ccPage||!a||this.ccPage==a},this.getCurrentPageNumber=function(){var b=a("#gform_source_page_number_"+this.formId);return b.length>0&&b.val()},this.maybeAddSpinner=function(){if(!this.isAjax)if("function"==typeof gformAddSpinner)gformAddSpinner(this.formId);else{var a=this.formId;if(0==jQuery("#gform_ajax_spinner_"+a).length){var b=gform.applyFilters("gform_spinner_url",gf_global.spinnerUrl,a),c=gform.applyFilters("gform_spinner_target_elem",jQuery("#gform_submit_button_"+a+", #gform_wrapper_"+a+" .gform_next_button, #gform_send_resume_link_button_"+a),a);c.after('<img id="gform_ajax_spinner_'+a+'"  class="gform_ajax_spinner" src="'+b+'" alt="" />')}}},this.resetStripeStatus=function(b,c,d){a("#gf_stripe_response, #gf_stripe_credit_card_last_four, #stripe_credit_card_type").remove(),b.data("gfstripesubmitting",!1),a("#gform_ajax_spinner_"+c).remove(),d&&(window["gf_submitting_"+c]=!1)},this.displayStripeCardError=function(b){var c="#input_"+this.formId+"_"+this.ccFieldId+"_1";a(c).next(".validation_message").length||a(c).after('<div class="gfield_description validation_message"></div>');var d=a(c).next(".validation_message");b.error?d.html(b.error.message):d.html("")},this.init()}}(jQuery);